- name: Deploy Saga Pegasus stack
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    supported_networks:
      - mainnet
      - testnet
      - staging
      - devnet
    supported_modes:
      - validator
      - fullnode
      - service-provider

  vars_files:
    - "{{ playbook_dir }}/../group_vars/all.yml"
    - "{{ playbook_dir }}/../group_vars/network/{{ network }}.yml"
    - "{{ playbook_dir }}/../group_vars/mode/{{ mode }}.yml"
  
  pre_tasks:
    - name: Validate network parameter
      fail:
        msg: "Invalid or missing 'network'. Must be one of: {{ supported_networks | join(', ') }}"
      when: network is not defined or network not in supported_networks

    - name: Validate mode parameter
      fail:
        msg: "Invalid or missing 'mode'. Must be one of: {{ supported_modes | join(', ') }}"
      when: mode is not defined or mode not in supported_modes

  roles:
    - { role: metrics, tags: [metrics], when: metrics_enabled }
    - { role: ingress-nginx, tags: [ingress-nginx], when: expose_p2p }
    - { role: spc, tags: [spc], when: spc_enabled }
    - { role: ssc, tags: [ssc] }
    - { role: controller-ccv, tags: [controller], when: controller_ccv }
    - { role: controller, tags: [controller], when: not controller_ccv }
